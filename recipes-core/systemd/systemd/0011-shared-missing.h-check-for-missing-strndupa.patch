From f41f93dbda705fc5f68e23d6f2f321dc972f687a Mon Sep 17 00:00:00 2001
From: Emil Renner Berthing <systemd@esmil.dk>
Date: Thu, 18 Sep 2014 15:24:49 +0200
Subject: [PATCH 11/17] shared/missing.h: check for missing strndupa

---
 configure.ac         |  3 ++-
 src/shared/missing.h | 11 +++++++++++
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index 27ffa76..ef6a310 100644
--- a/configure.ac
+++ b/configure.ac
@@ -329,9 +329,10 @@ LIBS="$save_LIBS"
 
 AC_CHECK_FUNCS([memfd_create])
 AC_CHECK_FUNCS([__secure_getenv secure_getenv])
-AC_CHECK_DECLS([gettid, pivot_root, canonicalize_file_name, name_to_handle_at, setns, getrandom, renameat2, kcmp, LO_FLAGS_PARTSCAN],
+AC_CHECK_DECLS([gettid, pivot_root, canonicalize_file_name, name_to_handle_at, strndupa, setns, getrandom, renameat2, kcmp, LO_FLAGS_PARTSCAN],
                [], [], [[
 #include <stdlib.h>
+#include <string.h>
 #include <sys/types.h>
 #include <unistd.h>
 #include <sys/mount.h>
diff --git a/src/shared/missing.h b/src/shared/missing.h
index e9ec76c..a01cacb 100644
--- a/src/shared/missing.h
+++ b/src/shared/missing.h
@@ -137,6 +137,17 @@ static inline char *canonicalize_file_name(const char *path) {
 }
 #endif
 
+#if !HAVE_DECL_STRNDUPA
+#define strndupa(s, n) \
+  ({ \
+    const char *__old = (s); \
+    size_t __len = strnlen(__old, (n)); \
+    char *__new = (char *)alloca(__len + 1); \
+    __new[__len] = '\0'; \
+    (char *)memcpy(__new, __old, __len); \
+  })
+#endif
+
 #ifndef __NR_memfd_create
 #  if defined __x86_64__
 #    define __NR_memfd_create 319
-- 
2.1.4

